# Traefik Dynamic Configuration
# This file configures the routers, middlewares, and services for Traefik
# =============================================================================

# HTTP Routers
http:
  routers:
    # Redirect HTTP to HTTPS for main domain
    llama-swappo-http:
      rule: "Host(`{{ .Domain | default \"localhost\" }}`)"
      entrypoints:
        - "http"
      middlewares:
        - "https-redirect"
      service: "llama-swappo"

    # HTTPS router for main service
    llama-swappo-https:
      rule: "Host(`{{ .Domain | default \"localhost\" }}`)"
      entrypoints:
        - "https"
      tls: {}
      service: "llama-swappo"
      middlewares:
        - "security-headers"

    # HTTPS router for health checks (if separate domain/subdomain needed)
    llama-swappo-health:
      rule: "Host(`{{ .Domain | default \"localhost\" }}`) && PathPrefix(`/health`)"
      entrypoints:
        - "https"
      tls: {}
      service: "llama-swappo"

    # HTTPS router for metrics (optional)
    llama-swappo-metrics:
      rule: "Host(`{{ .Domain | default \"localhost\" }}`) && PathPrefix(`/metrics`)"
      entrypoints:
        - "https"
      tls: {}
      service: "llama-swappo"
      middlewares:
        - "security-headers"
        - "metrics-auth"

  # Middlewares
  middlewares:
    # HTTPS redirection middleware
    https-redirect:
      redirectScheme:
        scheme: https
        permanent: true

    # Security headers middleware
    security-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "https"
        customResponseHeaders:
          X-Content-Type-Options: "nosniff"
          X-Frame-Options: "DENY"
          X-XSS-Protection: "1; mode=block"
          Strict-Transport-Security: "max-age=31536000; includeSubDomains; preload"
          Referrer-Policy: "strict-origin-when-cross-origin"
          Content-Security-Policy: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self';"
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true
        browserXssFilter: true
        contentTypeNosniff: true
        forceSTSHeader: true

    # Rate limiting middleware (optional)
    rate-limit:
      rateLimit:
        average: 100
        burst: 200
        period: "1m"

    # Compression middleware
    compression:
      compress:
        excludedContentTypes:
          - "text/event-stream"
          - "application/grpc"

    # Metrics authentication (optional - protect /metrics endpoint)
    metrics-auth:
      basicAuth:
        users:
          # Default: admin:admin (CHANGE FOR PRODUCTION!)
          # Generate with: htpasswd -nb username password
          - "admin:$apr1$6$oZ5hK6JzTp1Rm9x5sX2zG."

    # Health check middleware
    health-check:
      circuitBreaker:
        expression: "NetworkErrorRatio() > 0.5"
      retry:
        attempts: 3
        initialInterval: "100ms"

  # Services
  services:
    # Load balancer for llama-swappo
    llama-swappo:
      loadBalancer:
        servers:
          - url: "http://llama-swappo:8080"
        healthCheck:
          path: "/health"
          interval: "30s"
          timeout: "10s"
          followRedirects: true
        passHostHeader: true
        strategy: "RoundRobin"

# TLS Configuration
tls:
  certificates: []
  options:
    default:
      minVersion: "VersionTLS12"
      cipherSuites:
        - "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"
        - "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"
        - "TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305"
        - "TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384"
        - "TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256"
        - "TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305"
      sniStrict: true
      curvePreferences:
        - "CurveP521"
        - "CurveP384"
        - "CurveP256"

# Global configuration
global:
  checkNewVersion: false
  sendAnonymousUsage: false

# API Configuration
api:
  dashboard: true
  insecure: false
  debug: false

# Metrics Configuration
metrics:
  prometheus:
    addEntryPointsLabels: true
    addServicesLabels: true
    manualRouting: false

# Ping Configuration
ping:
  entryPoint: "traefik"

# Log Configuration
log:
  level: "INFO"
  format: "json"
  filePath: "/var/log/traefik/traefik.log"

# Access Log Configuration
accessLog:
  filePath: "/var/log/traefik/access.log"
  format: "json"
  bufferingSize: 100
  filters:
    statusCodes:
      - "400-499"
      - "500-599"
  fields:
    defaultMode: "keep"
    names:
      ClientUsername: "drop"
      ClientHost: "keep"
      RequestMethod: "keep"
      RequestPath: "keep"
      RequestProtocol: "keep"
      RequestPort: "keep"
      RequestScheme: "keep"
      RequestHost: "keep"
      RequestLine: "keep"
      RequestContentSize: "keep"
      OriginDuration: "keep"
      OriginContentSize: "keep"
      OriginStatus: "keep"
      DownstreamStatus: "keep"
      DownstreamContentSize: "keep"
      RequestAddr: "keep"
      RouterName: "keep"
      ServiceName: "keep"
      ServiceURL: "keep"
      StatusCode: "keep"
      Duration: "keep"
      StartUTC: "keep"
      StartLocal: "keep"
    headers:
      defaultMode: "keep"
      names:
        User-Agent: "keep"
        Authorization: "drop"
        Content-Type: "keep"

# Providers Configuration
providers:
  docker:
    endpoint: "unix:///var/run/docker.sock"
    exposedByDefault: false
    network: "traefik-public"
    watch: true
    useBindPortIP: false